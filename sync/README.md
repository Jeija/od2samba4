# Synchronization script with systemd timer
## Purpose
`sync.sh` is meant to be installed on the Samba4 Domain Controller you are migrating to. It automatically generates and copies the most recent KDC `mit_dump` dump file from the Open Directory server to the Samba4 Domain Controller, extracts password hashes and adds them together with new users to the Samba4 user directory. It will also establish new group memberships, but it won't migrate new groups. Modifications to existing users (except for new passwords) will not be migrated.

## Preparation
`sync.sh` requires python-ldap, sshpass and heimdal; on Debian, run the following command to install these packages:
```bash
apt install heimdal-clients heimdal-kdc python-ldap sshpass
```

`sync.sh` will NOT automatically copy the kerberos master key. Therefore, you need to manually copy the kerberos master key to the destination specified by `master_key` in `od2samba4.conf`. Both Open Directory and Samba4 must be running for `sync.sh` to work.

Configure `host`, `sshuser` and `sshpass` settings in od2samba4.conf. `sync.sh` will connect to the Open Directory server (at `sshuser@host` using `sshpass` as password) via SSH in order to remotely dump the Kerberos database and copy (`scp`) the database over to the Samba4 server. Alternatively, set up SSH key authentication and modify `sync.sh` accordingly.

Also, try running `sync.sh` prior to installing service file and timer so that you can detect and correct any configuration issues.

## Install systemd timer
Make sure to update the `ExecStart=` path in `od2samba4-sync.service` to point to your `sync.sh` script. Copy both `od2samba4-sync.service` and `od2samba4-sync.timer` to `/etc/systemd/system/` and enable the timer with
```bash
systemctl enable od2samba4-sync.timer
systemctl start od2samba4-sync.timer
```

The timer should now appear in the list generated by `systemctl list-timers` and `sync.sh` should be executed every 15 minutes (every full hour, *:15, *:30, *:45). `sync.sh` will also be started 1 minute after enabling the timer. Output can be monitored using `journalctl -fu od2samba4-sync`.
